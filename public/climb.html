<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climb Profile - Hardest Climbs in the World</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 id="climb-name">Loading...</h1>
            <p class="subtitle">Climb Profile</p>
        </header>
        
        <nav>
            <a href="/">Home</a>
            <a href="/sport">Sport Climbs</a>
            <a href="/boulder">Boulders</a>
            <a href="/athletes">Athletes</a>
            <a href="/export">üì• Export</a>
            <a href="/new">Submit</a>
        </nav>
        
        <main>
            <a href="/" class="back-link">‚Üê Back to Home</a>
            
            <div id="climb-content" class="loading">
                Loading climb profile...
            </div>
        </main>
    </div>

    <script>
        let climbData = null;
        
        async function loadClimbProfile() {
            const contentDiv = document.getElementById('climb-content');
            const nameDiv = document.getElementById('climb-name');
            
            // Get climb name and type from URL path
            const pathParts = window.location.pathname.split('/');
            const climbName = decodeURIComponent(pathParts[pathParts.length - 1]);
            const climbType = pathParts[pathParts.length - 2]; // 'sport' or 'boulder'
            
            if (!climbName || !climbType || (climbType !== 'sport' && climbType !== 'boulder')) {
                contentDiv.innerHTML = '<div class="error">Invalid climb URL</div>';
                return;
            }
            
            try {
                // Load climb data
                const climbResponse = await fetch(`/api/climbs?type=${climbType}&name=${encodeURIComponent(climbName)}`);
                const climbs = await climbResponse.json();
                
                if (climbs.length === 0) {
                    contentDiv.innerHTML = '<div class="error">Climb not found</div>';
                    return;
                }
                
                climbData = climbs[0];
                nameDiv.textContent = climbData.name;
                
                // Load climb's ascents
                const ascentsResponse = await fetch(`/api/ascents?climb=${encodeURIComponent(climbName)}`);
                const ascents = await ascentsResponse.json();
                
                // Display climb profile
                displayClimbProfile(climbData, ascents);
                
            } catch (error) {
                contentDiv.innerHTML = '<div class="error">Error loading climb profile: ' + error.message + '</div>';
            }
        }
        
        function displayClimbProfile(climb, ascents) {
            const contentDiv = document.getElementById('climb-content');
            
            // Get unique athletes
            const uniqueAthletes = [...new Set(ascents.map(a => a.athlete_name))];
            
            // Get first ascent and most recent
            const sortedAscents = ascents.sort((a, b) => new Date(a.date_of_ascent) - new Date(b.date_of_ascent));
            const firstAscent = sortedAscents[0];
            const mostRecent = sortedAscents[sortedAscents.length - 1];
            
            contentDiv.innerHTML = `
                <div class="card">
                    <div class="profile-header">
                        <div class="profile-info">
                            <div class="grade-badge large ${climb.climb_type}-badge">${climb.grade}</div>
                            <div class="profile-details">
                                ${climb.location ? 'üìç ' + climb.location : ''}
                                ${climb.country ? ' ‚Ä¢ ' + climb.country : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${climb.location ? `
                    <div class="info-box">
                        <strong>Location:</strong> ${climb.location}
                        ${climb.country ? ', ' + climb.country : ''}
                        ${climb.area ? ' (' + climb.area + ')' : ''}
                    </div>
                    ` : ''}
                    
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${ascents.length}</div>
                            <div class="stat-label">Total Ascents</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${uniqueAthletes.length}</div>
                            <div class="stat-label">Different Athletes</div>
                        </div>
                        ${firstAscent ? `
                        <div class="stat-card">
                            <div class="stat-number">${new Date(firstAscent.date_of_ascent).getFullYear()}</div>
                            <div class="stat-label">First Ascent</div>
                        </div>
                        ` : ''}
                        ${mostRecent && mostRecent.date_of_ascent !== firstAscent?.date_of_ascent ? `
                        <div class="stat-card">
                            <div class="stat-number">${new Date(mostRecent.date_of_ascent).getFullYear()}</div>
                            <div class="stat-label">Most Recent</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${ascents.length > 0 ? `
                <div class="mb-30">
                    <h2 class="section-title">Ascents</h2>
                    <div class="grid">
                        ${ascents.map(ascent => `
                            <div class="card">
                                <div class="profile-name">${ascent.athlete_name}</div>
                                <div class="text-muted mb-10">
                                    ${ascent.date_of_ascent ? new Date(ascent.date_of_ascent).toLocaleDateString() : ''}
                                    ${ascent.web_link ? ' ‚Ä¢ <a href="' + ascent.web_link + '" class="web-link" target="_blank">View Source</a>' : ''}
                                </div>
                                <a href="/athletes/${encodeURIComponent(ascent.athlete_name)}" class="link">View Athlete ‚Üí</a>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
        }
        
        // Load climb profile when page loads
        document.addEventListener('DOMContentLoaded', loadClimbProfile);
    </script>
</body>
</html>